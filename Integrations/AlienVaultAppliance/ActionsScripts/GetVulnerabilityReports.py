from SiemplifyUtils import output_handler
from SiemplifyAction import SiemplifyAction
from SiemplifyUtils import construct_csv
from AlienVaultManager import AlienVaultManager, AlienVaultManagerError
import base64
import json

PROVIDER = 'AlienVaultAppliance'
TABLE_NAME = 'Vulnerability Report Files'


@output_handler
def main():
    siemplify = SiemplifyAction()
    configurations = siemplify.get_configuration(PROVIDER)
    server_address = configurations['Api Root']
    username = configurations['Username']
    password = configurations['Password']

    result_value = False

    # Parameters
    number_of_files_to_fetch = int(siemplify.parameters.get('Number Of Files To Fetch', 1))

    alienvault_manager = AlienVaultManager(server_address, username, password)

    # Get pcap files records.
    vuln_reports = alienvault_manager.get_vulnerability_reports()

    final_vuln_reports = vuln_reports[:number_of_files_to_fetch]

    for vuln_report in final_vuln_reports:
        # Fetch file content.
        file_content = alienvault_manager.download_file_from_link(vuln_report.get('download_link'))

        file_name = "{0}_{1}.xlsx".format(vuln_report.get('creation_time'), vuln_report.get('Address'))
        siemplify.result.add_attachment(vuln_report.get('Address'),
                                        file_name,
                                        base64.b64encode(file_content))

    if vuln_reports:
        siemplify.result.add_data_table(TABLE_NAME, construct_csv(vuln_reports[:number_of_files_to_fetch]))
        result_value = True
        output_message = 'Found {0} vulnerability report files.'.format(len(vuln_reports[:number_of_files_to_fetch]))
    else:
        output_message = 'No vulnerability report files were found.'

    siemplify.result.add_result_json(final_vuln_reports)

    siemplify.end(output_message, result_value)


if __name__ == "__main__":
    main()





