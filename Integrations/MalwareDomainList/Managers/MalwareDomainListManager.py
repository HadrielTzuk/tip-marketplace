from io import StringIO
import pandas
import requests

# ============================== CONSTS ===================================== #

MDL_CSV_URL = "http://www.malwaredomainlist.com/mdlcsv.php"

# ============================= CLASSES ===================================== #


class MalwareDomainListManagerError(Exception):
    """
    General Exception for MalwareDomainList manager
    """
    pass


class MalwareDomainListManager(object):
    """
    MalwareDomainList Manager
    """
    def __init__(self, use_ssl=False):
        self.session = requests.Session()
        self.session.verify = use_ssl

    def test_connectivity(self):
        """
        Test connectivity to MalwareDomainList
        :return: {bool} True if successful, exception otherwise.
        """
        response = self.session.get(MDL_CSV_URL)
        self.validate_response(response, "Unable to connect to http://www.malwaredomainlist.com")

        return True

    def get_records_list(self):
        """
        Get the records table from MDL
        :return: {Dataframe} Pandas dataframe
        """
        response = self.session.get(MDL_CSV_URL)
        self.validate_response(response, "Unable to get records")

        df = pandas.read_csv(StringIO(response.content), header=None)
        df.columns = ["Date (UTC)", "Domain", "IP", "Reverse Lookup",
                      "Description", "Registrant", "ASN", "Inactive",
                      "Country", "None"]
        del df["None"]
        return df

    def get_domain_records(self, domain):
        records = self.get_records_list()
        return records[records['Domain'].str.match(domain)].to_dict(orient='records')

    @staticmethod
    def validate_response(response, error_msg="An error occurred"):
        try:
            response.raise_for_status()

        except requests.HTTPError as error:
            raise MalwareDomainListManagerError(
                "{error_msg}: {error} {text}".format(
                    error_msg=error_msg,
                    error=error,
                    text=error.response.content)
            )
