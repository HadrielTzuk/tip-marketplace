<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
    href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700,700i"
    rel="stylesheet">
  <link
    href='https://fonts.googleapis.com/css?family=Source Sans Pro'
    rel='stylesheet'>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <title>Query Widget</title>
  <style>
      :root {
          --dark-gray-100: hsl(0, 0%, 1000%);
          --dark-gray-200: hsl(216, 45%, 84%);
          --dark-gray-300: hsl(220, 22%, 62%);
          --dark-gray-400: hsl(221, 26%, 46%);
          --dark-gray-500: hsl(221, 30%, 33%);
          --dark-gray-600: hsl(221, 32%, 27%);
          --dark-gray-700: hsl(221, 35%, 23%);
          --dark-gray-800: hsl(221, 35%, 20%);
          --dark-gray-900: hsl(240, 25%, 12%);
          
          --color-table-even-row: hsl(226, 32%, 15%);
          --color-link: hsl(217, 89%, 76%);

          --widget-width-in-screen: 100%;
          --widget-height-in-screen: 100%;

          --widget-font-style: normal;

          --widget-text-font: 'Source Sans Pro', sans-serif;
          --widget-number-font: 'Open Sans', sans-serif;

          --font-weight-bold: 700;
          --font-weight-semibold: 600;
          --font-weight-regular: 400;

          --font-size-big: 16px;
          --font-size-medium: 14px;

          --default-line-height: 16px;

          --scrollbar-size: 12px;
      }

      html {
          height: var(--widget-height-in-screen);
          width: var(--widget-width-in-screen);
      }

      body {
          background-color: var(--dark-gray-800);

          height: var(--widget-height-in-screen);
          width: var(--widget-width-in-screen);

          padding: 0;
          margin: 0;

          overflow: hidden;
      }

      .logo {
          padding-bottom: 8px;
          padding-top: 8px;

          float: right;
      }

      .logo svg {
          height: 32px;

          vertical-align: top;
      }

      .main-counter {
          font-style: var(--widget-font-style);

          padding: 12px 4% 12px 4%;
          
          justify-content: center;
          clear: both;
      }

      .counter {
          font-weight: var(--font-weight-bold);
          font-family: var(--widget-number-font);

          color: var(--dark-gray-100);

          font-size: 64px;
          line-height: 0;

          align-items: center;
          text-align: center;
      }

      .counter-title {
          font-weight: var(--font-weight-semibold);
          font-family: var(--widget-text-font);

          color: var(--dark-gray-100);

          font-size: 20px;

          text-transform: uppercase;
          text-align: center;
      }
      
      .main-table {
          font-family: var(--widget-text-font);
          font-style: var(--widget-font-style);

          line-height: var(--default-line-height);

          color: var(--dark-gray-100);

          overflow-x: scroll;
      }

      .main-table table {
          font-size: var(--font-size-medium);

          width: 100%;

          border-collapse: collapse;
          word-break: keep-all;
      }

      .main-table th {
          font-weight: var(--font-weight-semibold);
          line-height: var(--default-line-height);

          background-color: var(--dark-gray-600);

          padding: 8px 16px;

          text-transform: uppercase;
          vertical-align: top;
          text-align: left;
          white-space: nowrap;
      }

      .main-table tr {
          font-weight: var(--font-weight-regular);
      }

      .main-table tr:nth-child(even) {
          background-color: var(--color-table-even-row);
      }

      .main-table td {
          padding: 8px 16px;

          vertical-align: top;
      }
      
      p.long-text {
          margin-top: 0;
          margin-bottom: 0px;
          white-space: pre-wrap;
          word-wrap: break-word;
          max-width: 500px;
      }

      .long-text .hidden-content {
          visibility: hidden;
          overflow: hidden;
          max-height: 0;
          float: left;
      }
  
      .widget-container {
          padding: 8px 16px 8px 10px;
          height: 100%;

          overflow: scroll;
      }

      ::-webkit-scrollbar {
          width: var(--scrollbar-size);
          height: var(--scrollbar-size);
      }

      ::-webkit-scrollbar-thumb {
          border-radius: 10px;
          border: 3px solid transparent;
          background: var(--dark-gray-400);
          background-clip: content-box;
      }

      ::-webkit-scrollbar-track {
          background-color: transparent;
      }

      ::-webkit-scrollbar-corner {
          background-color: transparent;
      }

      .link {
          color: var(--color-link);

          font-family: var(--widget-text-font);
          font-weight: var(--font-weight-regular);
          font-style: var(--widget-font-style);
          font-size: var(--font-size-medium);

          line-height: var(--default-line-height);

          text-decoration-line: underline;
          align-items: center;
      }
  </style>
</head>
  <body>
<div class="widget-container">
  <div class="logo">
<svg height="32" version="1.1" viewbox="0 0 32 32" width="32" xmlns="http://www.w3.org/2000/svg">
      <title>
        ElasticSearch_IntegrationImage
      </title>
      <path d="M18.688 17.792c-2.048-1.024-4.096-1.92-6.144-2.816-1.92 1.664-3.712 3.456-5.632 5.12-0.768 0.64-1.024 1.28-0.896 2.304 0 0.384 0.128 0.768 0.128 1.152 0.64 4.992 6.656 8.192 11.392 4.864 0.896-0.64 1.792-1.28 2.048-2.432 0.256-0.896 0.256-1.92 0.512-2.688 0.512-1.664 0.384-3.2-0.64-4.608-0.256-0.384-0.512-0.768-0.768-0.896zM13.312 14.208c1.792 0.896 3.712 1.664 5.504 2.56 0.384 0.128 0.512 0.128 0.768-0.128 1.92-1.664 3.712-3.328 5.632-4.992 0.512-0.384 0.64-0.896 0.768-1.408 0.256-4.608-3.584-7.936-7.424-7.808-1.792-0.128-3.328 0.64-4.736 1.664-0.768 0.64-1.28 1.408-1.536 2.56-0.128 1.024-0.128 1.152-0.256 1.792-0.384 1.792-0.64 3.456 0.512 4.992 0.256 0.256 0.512 0.64 0.768 0.768zM26.496 12.032c-2.048 1.792-4.096 3.584-6.144 5.376-0.128 0.128-0.128 0.384-0.128 0.64 0.256 0.64 0.64 1.28 0.896 1.92 0.128 0.128 0.384 0.384 0.512 0.384 1.408 0.384 2.816 0.64 4.352 1.024 0.128 0 0.384 0 0.512 0 1.792-0.64 3.2-2.432 3.2-4.48 0.128-2.432-1.152-3.968-3.2-4.864zM11.648 14.080c0.128-0.512-0.512-1.28-0.768-1.792-0.256-0.384-0.512-0.64-0.896-0.64-1.28-0.384-2.432-0.64-3.712-0.896-0.384-0.128-0.768-0.128-1.024 0-1.92 0.896-2.944 2.432-3.072 4.608 0.128 2.048 1.024 3.584 2.816 4.48 0.128 0.128 0.512 0 0.64-0.128 1.536-1.408 3.072-2.688 4.608-4.096 0.512-0.512 1.28-1.024 1.408-1.536zM25.6 22.272c-1.152-0.256-2.432-0.64-3.584-0.896-0.384-0.128-0.64 0-0.64 0.512-0.256 1.536-0.512 2.944-0.896 4.48 1.408 1.024 2.816 1.024 4.224 0.128 1.28-0.768 1.792-2.432 1.408-3.84-0.128-0.128-0.384-0.384-0.512-0.384zM6.528 9.728c1.28 0.256 2.56 0.64 3.968 0.896 0.384-1.664 0.768-3.2 1.024-4.864 0-0.128-0.128-0.384-0.384-0.512-1.152-0.768-2.304-0.768-3.584 0-1.152 0.768-1.792 1.792-1.664 3.2 0 0.512-0.128 1.152 0.64 1.28z">
      </path>
    </svg>
</div>
  <div class="main-counter">
  <h1 class="counter" id="counter"></h1>
  <h2 class="counter-title" id="counter-title"></h2>
</div>
  <div class="main-table">
  <table id="main-table">
    <thead id="main-table-header"></thead>
    <tbody id="main-table-body"></tbody>
  </table>
</div>
</div>
<script>
    $(document).ready(() => {
        if ($("body").css("background-color") === "rgb(255, 255, 255)") {
            $(".logo svg path").attr("fill", "black");
        } else {
            $(".logo svg path").attr("fill", "white");
        }
        
        const actionListData = [{stepInstanceName}.JsonResult];
        if (!actionListData.length) {
            return;
        }

        const dataCount = actionListData.length;
        if (dataCount === 1) {
            $("#counter-title").html("RESULT FOUND");
        } else {
            $("#counter-title").html("RESULTS FOUND");
        }

        $("#counter").html(dataCount);
        const iterListData = actionListData;
        const tableMapping = {};

        for (const item of iterListData) {
            for (const key of Object.keys(item)) {
                if (tableMapping[key] === undefined) {
                    tableMapping[key] = [];
                }
            }
        }

        for (const [heading, dataArray] of Object.entries(tableMapping)) {
            for (const item of iterListData) {
                dataArray.push(fieldExists(item[heading]));
            }
        }

        const initialValue = "";

        const keys = Object.keys(tableMapping);
        const headerHTML = `<tr>${keys.map(
            key => key.toString()
                .replace(/^[-_]*(.)/, (_, c) => c.toUpperCase())
                .replace(/[-_]+(.)/g, (_, c) => " " + c.toUpperCase())
        ).reduce((headerString, key) => headerString + `<th>${key}</th>`, initialValue)}</tr>`;

        const tableColumns = Object.values(tableMapping);
        // Transposing from columns to rows
        const tableRows = tableColumns[0].map((col, i) => tableColumns.map(row => row[i]));

        const isObject = obj => obj && obj.constructor === ({}).constructor;
        const bodyHTML = tableRows.reduce(
            (tableRows, tableRowArray) => tableRows + `<tr>${tableRowArray.reduce(
                (dataCells, dataCell) => {
                    if (Array.isArray(dataCell)) {
                        dataCell = dataCell
                            .map(item => isObject(item) ? JSON.stringify(item, null, 4) : item)
                            .join(", ");
                    } else if (isObject(dataCell)) {
                        dataCell = JSON.stringify(dataCell, null, 4);
                    }

                    return dataCells + `<td>${getCollapsableEscapedHTML(dataCell ? dataCell.toString() : "")}</td>`;
                },
                initialValue
            )}</tr>`,
            initialValue
        );

        $("#main-table-header").html(headerHTML);
        $("#main-table-body").html(bodyHTML);

        // Toggle off a column if all the values in it are "N/A"
        $("th").each(function (idx, _) {
            const check = Boolean(
                $("tbody tr").find("td:eq(" + idx + ")").filter(function () {
                    return ["N/A", ""].includes($.trim($(this).text())) ? 0 : 1;
                }).length
            );

            $("tr").find("td:eq(" + idx + "), th:eq(" + idx + ")").toggle(check);
        });

        function fieldExists(field) {
            return [undefined, ""].includes(field) ? "N/A" : field;
        }

        addLongTextClickLogic();

        function getCollapsableEscapedHTML(text, maxCharsLimit = 250) {
            if (!text) {
                return text;
            }

            if (text.length < maxCharsLimit) {
                return `<p class="long-text">${escapeHTML(text)}</p>`;
            }

            text = escapeHTML(text);
            let firstPart = text.slice(0, maxCharsLimit);
            let secondPart = text.slice(maxCharsLimit);

            const lastSpaceIndex = firstPart.lastIndexOf(" ");
            const spaceSearchPercentage = 0.6;
            const newMaxWithSpace = maxCharsLimit * spaceSearchPercentage;
            if (lastSpaceIndex >= newMaxWithSpace) {
                firstPart = text.slice(0, lastSpaceIndex);
                secondPart = text.slice(lastSpaceIndex);
            }

            return `<p class="long-text">` +
            `${firstPart}<span>... </span>` +
            `<br><a href="#" class="more link">Show more</a>` +
            `<span class="hidden-content">` +
            `${secondPart}` +
            `<br><a href="#" class="less link">Show less</a>` +
            `</span>` +
            `</p>`;
        }

        function addLongTextClickLogic() {
            $(".more").click(function (event) {
                event.preventDefault();
                $(this).hide()
                    .prev().hide()
                    .prev().hide();

                $(this).next().toggleClass("hidden-content");
            });

            $(".less").click(function (event) {
                event.preventDefault();
                $(this).parent().toggleClass("hidden-content")
                    .prev().show()
                    .prev().show()
                    .prev().show();
            });
        }

        function escapeHTML(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        
    });
</script>
</body>
</html>
